<!DOCTYPE html>
<html>

<head>
  <title>Irrigo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#2e7d32">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="title">
    <h1>Irri<span class="logo-go">Go</span></h1>
    <span class="tagline"><span class="tagline-highlight">Irri</span>gate your plants from anywhere you <span class="tagline-highlight">GO</span></span>
  </div>
  <div class="mode-toggle">
    <button class="mode-btn active" id="manual-tab" onclick="setMode('manual')">Manual</button>
    <button class="mode-btn" id="auto-tab" onclick="setMode('auto')">Auto</button>
  </div>

  <!-- Pump management section -->
  <div class="pump-section">
    <div class="pump-list" id="pump-list"></div>
  </div>

  <div class="modal-overlay" id="pump-modal" onclick="if(event.target===this)closeAddPumpModal()">
    <div class="modal">
      <h3>Add Pump</h3>
      <div class="pump-form">
        <input type="text" id="pump-name" placeholder="Name">
        <input type="number" id="pump-pin" placeholder="GPIO Pin" min="0">
      </div>
      <div class="modal-actions">
        <button class="start-btn" onclick="addPump()">Add</button>
        <button class="cancel-btn" onclick="closeAddPumpModal()">Cancel</button>
      </div>
    </div>
  </div>

  <div id="auto-panel" class="schedule-panel" style="display:none;">
    <div class="schedule-list" id="schedule-list"></div>
    <div class="schedule-form">
      <input type="time" id="sched-time">
      <input type="number" id="sched-duration" placeholder="Duration (s)" min="1">
      <button onclick="addSchedule()">Add</button>
    </div>
    <button id="scheduler-toggle" class="timer-toggle-btn" onclick="toggleScheduler()">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="13" r="8"/>
        <path d="M12 9v4l2.5 2.5"/>
        <path d="M12 5V3"/>
        <path d="M10 3h4"/>
      </svg>
      <span id="scheduler-label">Start Timer</span>
    </button>
  </div>

  <p id="status"></p>

  <div class="bottom-bar">
    <div class="plant-area">
      <img id="water-drop" src="assets/images/water-drop.svg" alt="Water Drop">
      <img id="plant" src="assets/images/car-plant.svg" alt="Plant">
    </div>
    <div id="manual-panel" class="controls">
      <button id="pump-toggle" class="pump-toggle-btn" onclick="togglePump()">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2v6" stroke="currentColor"/>
          <path d="M8 8h8v3a6 6 0 0 1-4 5.66A6 6 0 0 1 8 11V8z" stroke="currentColor"/>
          <path d="M10 21h4" stroke="currentColor"/>
          <path d="M12 17v4" stroke="currentColor"/>
          <circle cx="18" cy="5" r="2" stroke="currentColor" id="tap-drop" opacity="0"/>
        </svg>
      </button>
    </div>
  </div>

  <button class="fab" onclick="openAddPumpModal()">
    <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2C12 2 5 9 5 14a7 7 0 0 0 14 0c0-5-7-12-7-12z"/>
      <line x1="9" y1="14" x2="15" y2="14"/>
      <line x1="12" y1="11" x2="12" y2="17"/>
    </svg>
  </button>

  <script>
    const drop = document.getElementById('water-drop');
    const statusEl = document.getElementById('status');
    const manualPanel = document.getElementById('manual-panel');
    const autoPanel = document.getElementById('auto-panel');
    const manualTab = document.getElementById('manual-tab');
    const autoTab = document.getElementById('auto-tab');
    const scheduleList = document.getElementById('schedule-list');
    const pumpList = document.getElementById('pump-list');

    const pumpModal = document.getElementById('pump-modal');

    let currentMode = 'manual';
    let schedulerRunning = false;
    let pumpRunning = false;
    let schedules = [];
    let pumps = [];
    let selectedPumpId = null;

    function openAddPumpModal() {
      document.getElementById('pump-name').value = '';
      document.getElementById('pump-pin').value = '';
      pumpModal.classList.add('open');
    }

    function closeAddPumpModal() {
      pumpModal.classList.remove('open');
    }

    function setStatusMsg(msg, level) {
      statusEl.textContent = msg;
      statusEl.className = level || '';
    }

    function updatePumpBtn() {
      const btn = document.getElementById('pump-toggle');
      const tapDrop = document.getElementById('tap-drop');
      if (pumpRunning) {
        btn.classList.add('active');
        if (tapDrop) tapDrop.setAttribute('opacity', '1');
      } else {
        btn.classList.remove('active');
        if (tapDrop) tapDrop.setAttribute('opacity', '0');
      }
    }

    function updateStatus(state) {
      setStatusMsg('', '');
      if (state === 'on') {
        drop.classList.add('animate-drop');
        pumpRunning = true;
      } else {
        drop.classList.remove('animate-drop');
        pumpRunning = false;
      }
      updatePumpBtn();
    }

    function showMode(mode) {
      currentMode = mode;
      if (mode === 'manual') {
        manualPanel.style.display = '';
        autoPanel.style.display = 'none';
        manualTab.classList.add('active');
        autoTab.classList.remove('active');
      } else {
        manualPanel.style.display = 'none';
        autoPanel.style.display = '';
        manualTab.classList.remove('active');
        autoTab.classList.add('active');
      }
    }

    function getPumpName(pumpId) {
      const pump = pumps.find(p => p.id === pumpId);
      return pump ? pump.name : pumpId;
    }

    function selectPump(id) {
      selectedPumpId = id;
      document.querySelectorAll('.pump-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.pumpId === id);
      });
    }

    function renderPumps() {
      if (pumps.length === 0) {
        pumpList.innerHTML = '<p class="empty-msg">No pumps configured.</p>';
        selectedPumpId = null;
        return;
      }
      if (!selectedPumpId || !pumps.find(p => p.id === selectedPumpId)) {
        selectedPumpId = pumps[0].id;
      }
      pumpList.innerHTML = pumps.map(p =>
        '<div class="pump-card' + (p.id === selectedPumpId ? ' selected' : '') + '" data-pump-id="' + p.id + '" onclick="selectPump(\'' + p.id + '\')">' +
          '<div class="pump-card-info">' +
            '<span class="pump-card-name">' + p.name + '</span>' +
            '<span class="pump-card-pin">GPIO ' + p.pin + '</span>' +
          '</div>' +
          '<button class="delete-btn" onclick="event.stopPropagation();deletePump(\'' + p.id + '\')">Delete</button>' +
        '</div>'
      ).join('');
    }

    function renderSchedules() {
      if (schedules.length === 0) {
        scheduleList.innerHTML = '<p class="empty-msg">No schedules yet.</p>';
        return;
      }
      scheduleList.innerHTML = schedules.map((s, i) =>
        '<div class="schedule-item">' +
          '<span>' + s.time + ' — ' + s.duration + 's — ' + getPumpName(s.pump_id) + '</span>' +
          '<button class="delete-btn" onclick="deleteSchedule(' + i + ')">Delete</button>' +
        '</div>'
      ).join('');
    }

    function fetchPumps() {
      fetch('/pumps')
        .then(r => r.json())
        .then(data => {
          pumps = data;
          renderPumps();

        })
        .catch(() => {
          renderPumps();

        });
    }

    function addPump() {
      const name = document.getElementById('pump-name').value.trim();
      const pin = parseInt(document.getElementById('pump-pin').value, 10);
      if (!name) { alert('Please enter a pump name'); return; }
      if (isNaN(pin) || pin < 0) { alert('Please enter a valid GPIO pin'); return; }
      fetch('/pumps', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name, pin: pin})
      })
        .then(r => {
          if (!r.ok) return r.json().then(d => { alert(d.error); throw new Error(); });
          return r.json();
        })
        .then(() => {
          closeAddPumpModal();
          fetchPumps();
        })
        .catch(err => {
          if (err && err.message) return;
          alert('Failed to add pump — check server connection');
        });
    }

    function deletePump(id) {
      if (!confirm('Delete this pump and its schedules?')) return;
      fetch('/pumps/' + id, {method: 'DELETE'})
        .then(r => r.json())
        .then(data => {
          pumps = data.pumps || [];
          schedules = data.schedules || [];
          renderPumps();

          renderSchedules();
        })
        .catch(() => {});
    }

    function fetchMode() {
      fetch('/mode')
        .then(r => r.json())
        .then(data => {
          showMode(data.mode);
          schedules = data.schedules || [];
          pumps = data.pumps || [];
          renderSchedules();
          renderPumps();

        })
        .catch(() => {});
    }

    function setMode(mode) {
      showMode(mode);
      fetch('/mode', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({mode: mode})
      })
        .then(r => r.json())
        .then(data => {
          showMode(data.mode);
          schedules = data.schedules || [];
          renderSchedules();
        })
        .catch(() => {});
    }

    function addSchedule() {
      if (!selectedPumpId) { setStatusMsg('Select a pump first', 'warning'); return; }
      const time = document.getElementById('sched-time').value;
      const duration = parseInt(document.getElementById('sched-duration').value, 10);
      if (!time || !duration || duration < 1) return;
      const updated = schedules.concat([{time: time, duration: duration, pump_id: selectedPumpId}]);
      fetch('/schedule', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({schedules: updated})
      })
        .then(r => r.json())
        .then(data => {
          schedules = data.schedules || [];
          renderSchedules();
          document.getElementById('sched-time').value = '';
          document.getElementById('sched-duration').value = '';
        })
        .catch(() => {});
    }

    function deleteSchedule(index) {
      fetch('/schedule/' + index, {method: 'DELETE'})
        .then(r => r.json())
        .then(data => {
          schedules = data.schedules || [];
          renderSchedules();
        })
        .catch(() => {});
    }

    function fetchStatus() {
      fetch('/status')
        .then(r => r.json())
        .then(data => {
          updateStatus(data.status);
          if (data.mode && data.mode !== currentMode) {
            fetchMode();
          }
        })
        .catch(() => { setStatusMsg('Unable to reach server', 'error'); });
    }

    function togglePump() {
      if (!selectedPumpId) { setStatusMsg('Select a pump first', 'warning'); return; }
      const endpoint = pumpRunning ? '/stop' : '/start';
      fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pump_id: selectedPumpId})
      })
        .then(r => r.json())
        .then(data => updateStatus(data.status))
        .catch(() => { setStatusMsg('Failed to ' + (pumpRunning ? 'stop' : 'start'), 'warning'); });
    }

    function updateSchedulerBtn() {
      const btn = document.getElementById('scheduler-toggle');
      const label = document.getElementById('scheduler-label');
      if (schedulerRunning) {
        btn.classList.add('active');
        label.textContent = 'Stop Timer';
      } else {
        btn.classList.remove('active');
        label.textContent = 'Start Timer';
      }
    }

    function toggleScheduler() {
      if (schedulerRunning) {
        // Stop all scheduled pumps
        fetch('/stop', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({})
        })
          .then(r => r.json())
          .then(data => {
            updateStatus(data.status);
            schedulerRunning = false;
            updateSchedulerBtn();
            // Switch back to manual to stop the scheduler loop
            setMode('manual');
            showMode('auto');
          })
          .catch(() => { setStatusMsg('Failed to stop', 'warning'); });
      } else {
        // Start auto mode on the server
        fetch('/mode', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({mode: 'auto'})
        })
          .then(r => r.json())
          .then(data => {
            schedules = data.schedules || [];
            renderSchedules();
            schedulerRunning = true;
            updateSchedulerBtn();
          })
          .catch(() => { setStatusMsg('Failed to start timer', 'warning'); });
      }
    }

    // Initial load
    fetchStatus();
    fetchMode();
    setInterval(fetchStatus, 5000);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>

</body>

</html>
